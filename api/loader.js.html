<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" charset="utf-8">
    <title>Waigo - next-gen web framework</title><!--[if IE]><link rel="shortcut icon" href="img/logo_32x32.ico" /><![endif]-->
    <link rel="shortcut icon" href="/img/logo_114x114.png">
    <meta name="msapplication-TileColor" content="#fff">
    <meta name="msapplication-TileImage" content="/img/logo_144x144.png">
    <link rel="stylesheet" media="screen" href="/style.css">
  </head>
  <body>
    <header id="top">
      <nav role="banner" class="navbar navbar-fixed-top">
        <div class="navbar-header">
          <button type="button" data-toggle="collapse" data-target="#topmenu-navbar-collapse" class="navbar-toggle collapsed"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Waigo</a>
        </div>
        <div id="topmenu-navbar-collapse" role="navigation" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a id="guideNavItem" href="/#guide">Guide</a></li>
            <li class="active"><a href="/api">API</a></li>
            <li><a href="/examples.html">Examples</a></li>
            <li><a href="/sites.html">Sites</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/waigo/waigo">Github</a></li>
          </ul>
        </div>
      </nav>
    </header>
    <main id="content">
      <div id="api">
        <div class="container">
          <div class="row">
            <div role="complementary" class="col-md-3 waigo-api-index">
              <ul class="nav hidden-sm hidden-xs">
                <li><a href="index.html">Main</a></li>
                <li><a href="application.js.html">application.js</a></li>
                <li><a href="config/base.js.html">config/base.js</a></li>
                <li><a href="config/development.js.html">config/development.js</a></li>
                <li><a href="config/index.js.html">config/index.js</a></li>
                <li><a href="controllers/main.js.html">controllers/main.js</a></li>
                <li class="active"><a href="loader.js.html">loader.js</a></li>
                <li><a href="routes.js.html">routes.js</a></li>
                <li><a href="support/errors.js.html">support/errors.js</a></li>
                <li><a href="support/forms/field.js.html">support/forms/field.js</a></li>
                <li><a href="support/forms/fields/text.js.html">support/forms/fields/text.js</a></li>
                <li><a href="support/forms/form.js.html">support/forms/form.js</a></li>
                <li><a href="support/forms/sanitizers/trim.js.html">support/forms/sanitizers/trim.js</a></li>
                <li><a href="support/forms/validators/isEmailAddress.js.html">support/forms/validators/isEmailAddress.js</a></li>
                <li><a href="support/forms/validators/notEmpty.js.html">support/forms/validators/notEmpty.js</a></li>
                <li><a href="support/logging/winston.js.html">support/logging/winston.js</a></li>
                <li><a href="support/middleware/bodyParser.js.html">support/middleware/bodyParser.js</a></li>
                <li><a href="support/middleware/errorHandler.js.html">support/middleware/errorHandler.js</a></li>
                <li><a href="support/middleware/outputFormats.js.html">support/middleware/outputFormats.js</a></li>
                <li><a href="support/middleware/sessions.js.html">support/middleware/sessions.js</a></li>
                <li><a href="support/middleware/staticResources.js.html">support/middleware/staticResources.js</a></li>
                <li><a href="support/mixins.js.html">support/mixins.js</a></li>
                <li><a href="support/outputFormats/html.js.html">support/outputFormats/html.js</a></li>
                <li><a href="support/outputFormats/json.js.html">support/outputFormats/json.js</a></li>
                <li><a href="support/routeMapper.js.html">support/routeMapper.js</a></li>
                <li><a href="support/session/store/cookie.js.html">support/session/store/cookie.js</a></li>
                <li><a href="support/startup/database.js.html">support/startup/database.js</a></li>
                <li><a href="support/startup/listener.js.html">support/startup/listener.js</a></li>
                <li><a href="support/startup/logging.js.html">support/startup/logging.js</a></li>
                <li><a href="support/startup/middleware.js.html">support/startup/middleware.js</a></li>
                <li><a href="support/startup/routes.js.html">support/startup/routes.js</a></li>
                <li><a href="support/underscore.js.html">support/underscore.js</a></li>
              </ul>
              <div class="visible-sm visible-xs">
                <button type="button" data-toggle="collapse" data-target="#api-index-xs" class="btn btn-info">Show/hide API index</button>
                <div id="api-index-xs" class="collapse">
                  <ul class="nav">
                    <li><a href="index.html">Main</a></li>
                    <li><a href="application.js.html">application.js</a></li>
                    <li><a href="config/base.js.html">config/base.js</a></li>
                    <li><a href="config/development.js.html">config/development.js</a></li>
                    <li><a href="config/index.js.html">config/index.js</a></li>
                    <li><a href="controllers/main.js.html">controllers/main.js</a></li>
                    <li class="active"><a href="loader.js.html">loader.js</a></li>
                    <li><a href="routes.js.html">routes.js</a></li>
                    <li><a href="support/errors.js.html">support/errors.js</a></li>
                    <li><a href="support/forms/field.js.html">support/forms/field.js</a></li>
                    <li><a href="support/forms/fields/text.js.html">support/forms/fields/text.js</a></li>
                    <li><a href="support/forms/form.js.html">support/forms/form.js</a></li>
                    <li><a href="support/forms/sanitizers/trim.js.html">support/forms/sanitizers/trim.js</a></li>
                    <li><a href="support/forms/validators/isEmailAddress.js.html">support/forms/validators/isEmailAddress.js</a></li>
                    <li><a href="support/forms/validators/notEmpty.js.html">support/forms/validators/notEmpty.js</a></li>
                    <li><a href="support/logging/winston.js.html">support/logging/winston.js</a></li>
                    <li><a href="support/middleware/bodyParser.js.html">support/middleware/bodyParser.js</a></li>
                    <li><a href="support/middleware/errorHandler.js.html">support/middleware/errorHandler.js</a></li>
                    <li><a href="support/middleware/outputFormats.js.html">support/middleware/outputFormats.js</a></li>
                    <li><a href="support/middleware/sessions.js.html">support/middleware/sessions.js</a></li>
                    <li><a href="support/middleware/staticResources.js.html">support/middleware/staticResources.js</a></li>
                    <li><a href="support/mixins.js.html">support/mixins.js</a></li>
                    <li><a href="support/outputFormats/html.js.html">support/outputFormats/html.js</a></li>
                    <li><a href="support/outputFormats/json.js.html">support/outputFormats/json.js</a></li>
                    <li><a href="support/routeMapper.js.html">support/routeMapper.js</a></li>
                    <li><a href="support/session/store/cookie.js.html">support/session/store/cookie.js</a></li>
                    <li><a href="support/startup/database.js.html">support/startup/database.js</a></li>
                    <li><a href="support/startup/listener.js.html">support/startup/listener.js</a></li>
                    <li><a href="support/startup/logging.js.html">support/startup/logging.js</a></li>
                    <li><a href="support/startup/middleware.js.html">support/startup/middleware.js</a></li>
                    <li><a href="support/startup/routes.js.html">support/startup/routes.js</a></li>
                    <li><a href="support/underscore.js.html">support/underscore.js</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div role="main" class="col-md-7 waigo-api-content">
              <section id="init">
                <h1>init</h1>
                <div class="description"><p>Initialise the Waigo module file loader.</p>

<p>This scans the folder trees of the core framework, plugins and your<br />application to map out what's available and to ensure that there are no<br />instances of any given module file being provided by two or more plugins.<br />For more information on how Waigo decides where to load modules from see<br />the <code>load()</code> method.</p>

<p>If <code>options.plugins</code> is provided then those named plugins get loaded. If<br />not then the remaining options are used to first work out which plugins to<br />load and then those plugins get loaded. By default the plugins to load are<br />filtered from the dependencies listed within the <code>package.json</code> file.</p> </div>
                <h5 class="subheader"></h5>
                <p>
                  <div class="label label-info radius ctx-type">method</div>
                </p>
              </section>
              <table class="params table table-bordered table-striped">
                <thead>
                  <tr>
                    <th style="width:20%">Option</th>
                    <th style="width:20%">Type</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="name">[options]</td>
                    <td class="type">Object</td>
                    <td class="description">Loading configuration.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.appFolder]</td>
                    <td class="type">String</td>
                    <td class="description">Absolute path to folder containing app files. Overrides the default calculated folder.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.plugins]</td>
                    <td class="type">Object</td>
                    <td class="description">Plugin loading configuration.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.plugins.names]</td>
                    <td class="type">Array</td>
                    <td class="description">Plugins to load. If omitted then other options are used to load plugins.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.plugins.glob]</td>
                    <td class="type">Array</td>
                    <td class="description">Regexes specifying plugin naming conventions. Default is `waigo-*`.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.plugins.config]</td>
                    <td class="type">String</td>
                    <td class="description">JSON config containing names of plugins to load. Default is to load `package.json`.</td>
                  </tr>
                  <tr>
                    <td class="name">[options.plugins.configKey]</td>
                    <td class="type">Array</td>
                    <td class="description">Names of keys in JSON config whose values contain names of plugins. Default is `dependencies, devDependencies, peerDependencies`.</td>
                  </tr>
                </tbody>
              </table>
              <pre><code class="language-javascript">loader.init = function*(options) {
  if (loader.__modules) {
    debug('Waigo already initialised. Re-initialising...');
  }

  options = options || {};
  options.plugins = options.plugins || {};

  appFolder = options.appFolder || appFolder;

  // get loadable plugin
  if (!options.plugins.names) {
    debug('Getting plugin names...');
    
    // based on code from https://github.com/sindresorhus/load-grunt-tasks/blob/master/load-grunt-tasks.js
    var pattern = options.plugins.glob || ['waigo-*'];
    var config = options.plugins.config || 'package.json';
    var scope = options.plugins.configKey || ['dependencies', 'devDependencies', 'peerDependencies'];
    
    if ('string' === typeof config) {
      if ('package.json' === config) {
        config = findup('package.json');
      } else {
        config = require(path.resolve(config));        
      }
    }

    var names = scope.reduce(function (result, prop) {
      return result.concat(Object.keys(config[prop] || {}));
    }, []);

    options.plugins.names = _.uniq(globule.match(pattern, names));
  }
  
  debug('Plugins to load: ' + options.plugins.names.join(', '));

  // scan all folder trees and build up the available modules...
  loader.__modules = {};

  var sourcePaths = {
    waigo: waigoFolder,
    app: appFolder
  };

  _.each(options.plugins.names, function(name) {
    sourcePaths[name] = path.join( path.dirname(require.resolve(name)), 'src' );
  });

  var scanOrder = ['waigo'].concat(options.plugins.names, 'app');

  for (var i = 0; i &lt; scanOrder.length; ++i) {
    var sourceName = scanOrder[i],
      moduleMap = yield _walk(sourcePaths[sourceName]);

    _.each(moduleMap, function(modulePath, moduleName) {
      loader.__modules[moduleName] = loader.__modules[moduleName] || { 
        sources: {} 
      };
      loader.__modules[moduleName].sources[sourceName] = modulePath;
    });
  }

  // now go through the list of available modules and ensure that there are no ambiguities
  _.each(loader.__modules, function(moduleConfig, moduleName) {
    var sourceNames = Object.keys(moduleConfig.sources);

    // if there is an app implementation then that's the one to use
    if (moduleConfig.sources.app) {
      moduleConfig._load = 'app';
    } 
    // if there is only one source then use that one
    else if (1 === sourceNames.length) {
      moduleConfig._load = sourceNames[0];
    }
    // else
    else {
      // get plugin source names
      var pluginSources = _.filter(sourceNames, function(srcName) {
        return 'waigo' !== srcName;
      });

      // if more than one plugin then we have a problem
      if (1 &lt; pluginSources.length) {
        throw new Error('Module &quot;' + moduleName + '&quot; has more than one plugin implementation to choose from: ' + pluginSources.join(', '));
      } 
      // else the one available plugin is the source
      else {
        moduleConfig._load = pluginSources[0];
      }
    }

    debug('Module &quot;' + moduleName + '&quot; will be loaded from source &quot;' + moduleConfig._load + '&quot;');
  });
};</code></pre>
              <section id="load">
                <h1>load</h1>
                <div class="description"><p>Load a Waigo module file.</p>

<p>Names to load are specified in the form: <code>[npm_module_name:]&lt;module_file_path&gt;</code></p>

<p>If <code>npm_module_name:</code> is not given then Waigo works out the which version<br />of the module file to load according to the following priority order: <strong>App ><br />plugins > core framework</strong>.</p>

<p>Thus an app can completely override any of the framework's built-in module<br />files.</p>

<p>For example, when a call to load the <code>support/errors</code> module is made Waigo<br />checks the following paths in order until a match is found:</p>

<ul>
<li><code>&lt;app folder&gt;/support/errors.js</code></li>
<li><code>&lt;waigo plugin 1&gt;/src/support/errors.js</code></li>
<li><code>&lt;waigo plugin 2&gt;/src/support/errors.js</code></li>
<li><code>&lt;waigo plugin...&gt;/src/support/errors.js</code></li>
<li><code>&lt;waigo plugin N&gt;/src/support/errors.js</code></li>
<li><code>&lt;waigo module&gt;/src/support/errors.js</code></li>
</ul>

<p>In the above example, if the caller wishes to explicitly load the version<br />provided by the <code>waigo-doc</code> plugin then the parameter should be<br /><code>waigo-doc:support/errors</code>. If on the other hand they wish to load the<br />version provided the core Waigo framework then <code>waigo:support/errors</code><br />should be used.</p> </div>
                <h5 class="subheader"></h5>
                <p>
                  <div class="label label-info radius ctx-type">method</div><span class="symbolReturns">-> Object</span>
                </p>
              </section>
              <table class="params table table-bordered table-striped">
                <thead>
                  <tr>
                    <th style="width:20%">Option</th>
                    <th style="width:20%">Type</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="name">moduleFileName</td>
                    <td class="type">string</td>
                    <td class="description">Module file name in the supported format (see above).</td>
                  </tr>
                </tbody>
              </table>
              <pre><code class="language-javascript">loader.load = function(moduleName) {
  if (!loader.__modules) {
    throw new Error('Please initialise Waigo first');
  }

  // get source to load from
  var sanitizedModuleName = moduleName,
    source = null;

  var sepPos = moduleName.indexOf(':')
  if (-1 &lt; sepPos) {
    source = moduleName.substr(0, sepPos);
    sanitizedModuleName = moduleName.substr(sepPos + 1);
  }

  if (!loader.__modules[sanitizedModuleName]) {
    throw new Error('Module not found: ' + sanitizedModuleName);
  }

  // if no source then use default
  if (!source) {
    source = loader.__modules[sanitizedModuleName]._load;
  }

  if (!loader.__modules[sanitizedModuleName].sources[source]) {
    throw new Error('Module source not found: ' + source);
  }

  debug('Loading module &quot;' + sanitizedModuleName + '&quot; from source &quot;' + source + '&quot;');

  return require(loader.__modules[sanitizedModuleName].sources[source]);
};</code></pre>
              <section id="getWaigoFolder">
                <h1>getWaigoFolder</h1>
                <div class="description"><p>Get absolute path to folder containing the Waigo framework.</p> </div>
                <h5 class="subheader"></h5>
                <p>
                  <div class="label label-info radius ctx-type">method</div><span class="symbolReturns">-> String</span>
                </p>
              </section>
              <pre><code class="language-javascript">loader.getWaigoFolder = function() {
  return waigoFolder;
};</code></pre>
              <section id="getAppFolder">
                <h1>getAppFolder</h1>
                <div class="description"><p>Get absolute path to folder containing the application code.</p> </div>
                <h5 class="subheader"></h5>
                <p>
                  <div class="label label-info radius ctx-type">method</div><span class="symbolReturns">-> String</span>
                </p>
              </section>
              <pre><code class="language-javascript">loader.getAppFolder = function() {
  return appFolder;
};





module.exports = loader;</code></pre>
            </div>
            <div class="col-md-2">
              <div role="complementary" class="waigo-content-menu hidden-print">
                <ul class="nav">
                  <li><a href="#init"><span>init()</span></a></li>
                  <li><a href="#load"><span>load()</span></a></li>
                  <li><a href="#getWaigoFolder"><span>getWaigoFolder()</span></a></li>
                  <li><a href="#getAppFolder"><span>getAppFolder()</span></a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer role="contentinfo"><p>This page was <a href="https://github.com/waigo/waigojs.com-generator">generated</a> on Fri, 09 May 2014 07:58:20 GMT</p>

    </footer>
    <script type="text/javascript" src="/scripts.js"></script>
    <script type="text/javascript">
      var _paq = _paq || [];
      _paq.push(["setDomains", ["*.waigojs.com","*.waigo.github.io"]]);
      _paq.push(["trackPageView"]);
      _paq.push(["enableLinkTracking"]);
      (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http") + "://piwik.hiddentao.com/";
        _paq.push(["setTrackerUrl", u+"piwik.php"]);
        _paq.push(["setSiteId", "3"]);
        var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
        g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
      })();
      
    </script>
  </body>
</html>